{
"AWSTemplateFormatVersion" : "2010-09-09",
"Description" : "Company - EMR Cluster creation template",

	"Parameters" : {
		"EMRClusterName": {
      "Description": "Name of EMR Cluster",
      "Type": "String"
    },
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH to the instances",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Default" : "emr-production"
    },
    "Subnet": {
      "Description": "Subnet ID for creating the EMR cluster",
      "Type": "AWS::EC2::Subnet::Id"
    }
  },

  "Mappings" : {
    "InstanceSettings" : {
      "MasterInstanceGroup" : { "ami" : "ami-0d813873ae264f8f8", "instancetype" : "m3.xlarge", "instancecount" : "1", "securitygroup" : "sg-4843e534" },
      "CoreInstanceGroup" : { "ami" : "ami-0d813873ae264f8f8", "instancetype" : "m3.xlarge", "instancecount" : "1", "securitygroup" : "sg-4843e535"  }
    }
  },

  "Resources" : {
    "EMRInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Roles": [
          {
            "Ref": "EMRJobFlowRole"
          }
        ]
      }
    },

    "EMRJobFlowRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service":
                [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ]
        },
        "ManagedPolicyArns":
          [
            "arn:aws:iam::aws:policy/service-role/AmazonElasticMapReduceforEC2Role"
          ]
        }
      },

      "EMRServiceRole": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "AssumeRolePolicyDocument": {
            "Statement": [
              {
                "Action": [
                  "sts:AssumeRole"
                ],
                "Effect": "Allow",
                "Principal": {
                  "Service": [
                      "elasticmapreduce.amazonaws.com"
                  ]
                }
              }
            ]
          },
          "ManagedPolicyArns": [
              "arn:aws:iam::aws:policy/service-role/AmazonElasticMapReduceRole"
          ]
        }
      },

      "EMRCluster" : {
        "Type" : "AWS::EMR::Cluster",
        "Properties" : {
          "Applications" : [
            {
              "Name" : "Hive"
            },
            {
              "Name" : "Pig"
            },
            {
              "Name" : "Hue"
            },
            {
              "Name" : "Spark"
            },
            {
              "Name" : "Zeppelin"
            },
            {
              "Name" : "HCatalog"
            },
            {
              "Name" : "Flink"
            },
            {
              "Name" : "Livy"
            },
            {
              "Name" : "Ganglia"
            }
          ],
          "AutoScalingRole" : "EMR_AutoScaling_DefaultRole",
          "Configurations" : [
            {
              "Classification": "hive-site",
              "ConfigurationProperties": {
                "hive.metastore.client.factory.class": "com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory"
              }
            },
            {
              "Classification": "spark-hive-site",
              "ConfigurationProperties": {
                "hive.metastore.client.factory.class": "com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory"
              }
            }
          ],
          "Instances" : {
            "MasterInstanceGroup": {
                "InstanceCount": { "Fn::FindInMap" : [ "InstanceSettings", "CoreInstanceGroup", "instancecount" ] },
                "InstanceType": { "Fn::FindInMap" : [ "InstanceSettings", "MasterInstanceGroup", "instancetype" ] },
                "Name": { "Fn::Join" : [ "-", [ { "Ref" : "EMRClusterName" }, "Master" ] ] }
            },
            "CoreInstanceGroup": {
                "InstanceCount": { "Fn::FindInMap" : [ "InstanceSettings", "CoreInstanceGroup", "instancecount" ] },
                "InstanceType": { "Fn::FindInMap" : [ "InstanceSettings", "CoreInstanceGroup", "instancetype" ] },
                "Name": { "Fn::Join" : [ "-", [ { "Ref" : "EMRClusterName" }, "Core" ] ] }
            },
            "Ec2KeyName": { "Ref": "KeyName" },
            "Ec2SubnetId" : { "Ref" : "Subnet" }
          },
          "JobFlowRole" : { "Ref" : "EMRInstanceProfile" },
          "Name" : { "Ref" : "EMRClusterName" },
          "ReleaseLabel" : "emr-5.15.0",
          "ServiceRole" : { "Ref" : "EMRServiceRole" },
          "Tags":
            [
              {
                "Key": "Name",
                "Value": { "Ref" : "EMRClusterName" }
              }
            ],
          "VisibleToAllUsers" : "true"
        }
      }
  },

	"Outputs" : {
		"EMRClusterName" : {
			"Value" : { "Ref" : "EMRClusterName" },
			"Description" : "EMR Cluster Name"
		},
		"Subnet" : {
			"Value" : { "Ref" : "Subnet" },
			"Description" : "Chosen subnet to deploy EMR cluster to"
		},
		"KeyName" : {
			"Value" : { "Ref" : "KeyName" },
			"Description" : "Chosen keypair name"
		},
		"ClusterId" : {
			"Value" : { "Ref" : "EMRCluster" },
			"Description" : "EMR ClusterId"
		}
	}
}
